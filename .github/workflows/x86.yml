name: Build WPF App
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [x86, x64, arm64]
        configuration: [Release]
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
      id: get_latest_release
      run: |
        try {
          $latest = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest").tag_name
          $number = [int]($latest -replace '[^0-9]')
          $nextNumber = $number + 1
        } catch {
          $nextNumber = 1
        }
        echo "NEXT_VERSION_NUMBER=$nextNumber" >> $env:GITHUB_ENV

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          echo "VERSION=${{ github.event.inputs.version }}" >> $env:GITHUB_ENV
        } else {
          echo "VERSION=1.0.${{ env.NEXT_VERSION_NUMBER }}" >> $env:GITHUB_ENV
        }
        
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore -r win-${{ matrix.architecture }}
      
    - name: æ„å»º
      run: |
        dotnet publish å·¥å…·ç®±.csproj `
          -c ${{ matrix.configuration }} `
          -r win-${{ matrix.architecture }} `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ env.VERSION }} `
          -p:PublishTrimmed=true `
          -p:TrimMode=link `
          -p:DebugType=none `
          -p:DebugSymbols=false `
          -o publish/${{ matrix.architecture }}

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: Toolbox-${{ matrix.architecture }}
        path: publish/${{ matrix.architecture }}

  create-release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      
    - name: åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…
      run: |
        foreach ($arch in @('x86', 'x64', 'arm64')) {
          $zipPath = "Toolbox-$arch.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          Get-ChildItem -Path "Toolbox-$arch" | Compress-Archive -DestinationPath $zipPath -CompressionLevel Optimal
        }
        
    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        $changeLog = @"
        ## ğŸš€ å‘å¸ƒè¯´æ˜
        
        ### âœ¨ æ–°ç‰¹æ€§
        - é›†æˆå¤šæ¬¾ç³»ç»Ÿä¼˜åŒ–å·¥å…·
        - ä¸€é”®å¼å·¥å…·å¯åŠ¨åŠŸèƒ½
        - èµ„æºå†…åµŒï¼Œæ— éœ€é¢å¤–ä¸‹è½½
        
        ### ğŸ“¥ ä¸‹è½½è¯´æ˜
        - Toolbox-x64.zip - 64ä½ç³»ç»Ÿç‰ˆæœ¬
        - Toolbox-x86.zip - 32ä½ç³»ç»Ÿç‰ˆæœ¬
        - Toolbox-arm64.zip - ARMæ¶æ„ç‰ˆæœ¬
        
        ### ğŸ’» ç³»ç»Ÿè¦æ±‚
        - Windows 10/11
        - .NET 6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
        - 1GBä»¥ä¸Šå¯ç”¨ç©ºé—´
        
        ### ğŸ” SHA256æ ¡éªŒ
        $((Get-ChildItem -Filter "Toolbox-*.zip" | ForEach-Object {
          "$($_.Name): $((Get-FileHash $_.FullName -Algorithm SHA256).Hash)"
        }) -join "`n")
        "@
        $changeLog | Out-File -FilePath changelog.md -Encoding utf8
        
    - name: åˆ›å»ºå‘å¸ƒ
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        release_name: è¿ç»´å·¥å…·ç®± v${{ env.VERSION }}
        body_path: changelog.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          Toolbox-x86.zip
          Toolbox-x64.zip
          Toolbox-arm64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}