name: Build WPF App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 手动触发构建
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [x86, x64, arm64]
        configuration: [Release]

    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      
    - name: 设置 .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: 还原依赖
      run: dotnet restore -r win-${{ matrix.architecture }}

    - name: 构建
      run: |
        dotnet publish 工具箱.csproj `
          -c ${{ matrix.configuration }} `
          -r win-${{ matrix.architecture }} `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -o publish/${{ matrix.architecture }}

    - name: 上传构建产物
      uses: actions/upload-artifact@v3
      with:
        name: 运维工具箱-${{ matrix.architecture }}
        path: publish/${{ matrix.architecture }}

  create-release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v3

    - name: 创建发布压缩包
      run: |
        foreach ($arch in @('x86', 'x64', 'arm64')) {
          Compress-Archive -Path "运维工具箱-$arch/*" -DestinationPath "运维工具箱-$arch.zip"
        }

    - name: 创建发布
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false
        files: |
          运维工具箱-x86.zip
          运维工具箱-x64.zip
          运维工具箱-arm64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}